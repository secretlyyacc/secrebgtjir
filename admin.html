<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>LyyShop ID - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent}
        body{background:linear-gradient(135deg,#0a2647 0%,#0f2b4f 100%);min-height:100vh;color:white;overflow-x:hidden}
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-track{background:rgba(255,255,255,0.03);border-radius:10px}
        ::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#60a5fa,#1e3a8a);border-radius:10px}
        .glass{background:rgba(255,255,255,0.03);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.05);border-radius:16px}
        .glass-card{background:rgba(255,255,255,0.02);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,0.05);border-radius:16px;transition:all 0.3s ease}
        .glass-card:hover{border-color:#60a5fa;box-shadow:0 10px 30px rgba(96,165,250,0.1)}
        .btn-primary{background:linear-gradient(135deg,#1e3a8a,#60a5fa);color:white;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.3s ease;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.95rem}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(96,165,250,0.3)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
        .btn-secondary{background:rgba(255,255,255,0.05);color:white;padding:12px 24px;border-radius:12px;font-weight:600;border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s ease;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.95rem}
        .btn-secondary:hover{background:rgba(255,255,255,0.1);border-color:#60a5fa}
        .btn-danger{background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.3s ease}
        .btn-danger:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(220,38,38,0.3)}
        .badge{padding:4px 12px;border-radius:20px;font-size:0.7rem;font-weight:600;display:inline-block;white-space:nowrap}
        .badge-pending{background:#f59e0b;color:white}
        .badge-paid{background:#60a5fa;color:white}
        .badge-completed{background:#10b981;color:white}
        .badge-cancelled{background:#ef4444;color:white}
        .form-input{width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:white;transition:all 0.3s ease;font-size:0.95rem}
        .form-input:focus{outline:none;border-color:#60a5fa;background:rgba(255,255,255,0.1)}
        .form-input::placeholder{color:rgba(255,255,255,0.3)}
        select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2360a5fa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");background-position:right 12px center;background-repeat:no-repeat;background-size:20px;padding-right:40px}
        select.form-input option{background:#0a2647;color:white}
        .table-header{padding:12px 16px;text-align:left;font-size:0.7rem;font-weight:600;text-transform:uppercase;color:rgba(255,255,255,0.5);border-bottom:1px solid rgba(255,255,255,0.1)}
        .table-cell{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.9rem}
        .table-row{transition:all 0.2s ease;cursor:pointer}
        .table-row:hover{background:rgba(96,165,250,0.1)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s ease;padding:16px}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal-content{background:linear-gradient(135deg,#0a2647,#0f2b4f);border:1px solid #60a5fa;border-radius:24px;padding:24px;max-width:500px;width:100%;max-height:85vh;overflow-y:auto;transform:translateY(20px);transition:all 0.3s ease}
        .modal-overlay.active .modal-content{transform:translateY(0)}
        .file-drop-area{border:2px dashed rgba(255,255,255,0.2);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all 0.3s ease}
        .file-drop-area:hover{border-color:#60a5fa;background:rgba(96,165,250,0.1)}
        .file-drop-area.dragover{border-color:#60a5fa;background:rgba(96,165,250,0.2);transform:scale(1.02)}
        .toast{position:fixed;bottom:20px;right:20px;left:20px;margin:0 auto;max-width:350px;padding:16px 24px;border-radius:12px;background:rgba(10,38,71,0.95);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid #60a5fa;color:white;z-index:2000;animation:slideIn 0.3s ease;text-align:center}
        .toast.error{background:rgba(220,38,38,0.95);border-color:#ef4444}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:#60a5fa;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        .sidebar{width:280px;height:100vh;position:fixed;left:0;top:0;background:rgba(10,38,71,0.98);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-right:1px solid rgba(255,255,255,0.05);overflow-y:auto;z-index:100}
        .sidebar-link{display:flex;align-items:center;padding:16px 20px;color:rgba(255,255,255,0.7);transition:all 0.3s ease;border-left:3px solid transparent;gap:12px;font-size:0.95rem}
        .sidebar-link:hover{background:rgba(96,165,250,0.1);color:white}
        .sidebar-link.active{background:rgba(96,165,250,0.15);border-left-color:#60a5fa;color:white}
        .main-content{margin-left:280px;padding:20px}
        .stat-card{background:rgba(255,255,255,0.03);border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.05);transition:all 0.3s ease}
        .stat-card:hover{border-color:#60a5fa;transform:translateY(-5px)}
        .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
        @media (max-width:1024px){.sidebar{width:240px}.main-content{margin-left:240px}}
        @media (max-width:768px){
            .sidebar{width:100%;height:auto;position:relative;border-right:none;border-bottom:1px solid rgba(255,255,255,0.05)}
            .main-content{margin-left:0;padding:16px}
            .products-grid{grid-template-columns:1fr}
            .table-header,.table-cell{font-size:0.8rem;padding:8px}
        }
        @media (max-width:480px){
            .btn-primary,.btn-secondary{padding:10px 16px;font-size:0.9rem}
            .modal-content{padding:20px}
            .stat-card{padding:16px}
        }
        .hover-lift{transition:transform 0.2s ease}
        .hover-lift:hover{transform:translateY(-2px)}
        .animate-pulse{animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .break-all{word-break:break-all}
        .overflow-x-auto{overflow-x:auto;-webkit-overflow-scrolling:touch}
    </style>
</head>
<body>
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card p-6 sm:p-8 rounded-2xl w-full max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-[#1e3a8a] to-[#60a5fa] flex items-center justify-center animate-pulse">
                    <i class="fas fa-crown text-white text-2xl sm:text-3xl"></i>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold">LyyTechID Admin</h1>
                <p class="text-gray-400 text-xs sm:text-sm mt-2">Secure Access Required</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Username</label>
                    <input type="text" id="loginUsername" required class="form-input" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Password</label>
                    <input type="password" id="loginPassword" required class="form-input" placeholder="Enter password">
                </div>
                <button type="submit" class="btn-primary mt-2">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
            </form>
            <div id="loginError" class="mt-4 p-3 bg-red-500/10 border border-red-500/30 text-red-400 rounded-lg text-sm hidden"></div>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="sidebar">
            <div class="p-4 sm:p-6 border-b border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-gradient-to-br from-[#1e3a8a] to-[#60a5fa] flex items-center justify-center">
                        <i class="fas fa-store text-white"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-sm sm:text-base">LyyTechID</h2>
                        <p class="text-xs text-gray-400" id="adminName">Admin</p>
                    </div>
                </div>
            </div>
            <nav class="p-3 sm:p-4 space-y-1">
                <a href="#" onclick="showSection('dashboard')" class="sidebar-link"><i class="fas fa-chart-pie w-6"></i><span class="flex-1">Dashboard</span></a>
                <a href="#" onclick="showSection('orders')" class="sidebar-link"><i class="fas fa-shopping-cart w-6"></i><span class="flex-1">Orders</span><span id="pendingBadge" class="bg-red-500 text-xs px-2 py-1 rounded-full hidden">0</span></a>
                <a href="#" onclick="showSection('accounts')" class="sidebar-link"><i class="fas fa-database w-6"></i><span class="flex-1">Account Stock</span><span id="stockBadge" class="bg-green-500 text-xs px-2 py-1 rounded-full">0</span></a>
                <a href="#" onclick="showSection('products')" class="sidebar-link"><i class="fas fa-box w-6"></i><span class="flex-1">Products</span></a>
                <a href="#" onclick="showSection('settings')" class="sidebar-link"><i class="fas fa-cog w-6"></i><span class="flex-1">Settings</span></a>
                <div class="border-t border-white/10 my-4"></div>
                <a href="#" onclick="logout()" class="sidebar-link text-red-400"><i class="fas fa-sign-out-alt w-6"></i><span class="flex-1">Logout</span></a>
            </nav>
        </div>

        <div class="main-content">
            <div id="dashboardSection" class="space-y-4 sm:space-y-6">
                <h1 class="text-2xl sm:text-3xl font-bold">Dashboard Overview</h1>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <div class="stat-card"><p class="text-gray-400 text-xs sm:text-sm">Total Orders</p><h2 class="text-xl sm:text-2xl font-bold mt-2" id="totalOrders">0</h2></div>
                    <div class="stat-card"><p class="text-gray-400 text-xs sm:text-sm">Completed</p><h2 class="text-xl sm:text-2xl font-bold mt-2 text-green-400" id="completedOrders">0</h2></div>
                    <div class="stat-card"><p class="text-gray-400 text-xs sm:text-sm">Pending</p><h2 class="text-xl sm:text-2xl font-bold mt-2 text-yellow-400" id="pendingOrders">0</h2></div>
                    <div class="stat-card"><p class="text-gray-400 text-xs sm:text-sm">Revenue</p><h2 class="text-xl sm:text-2xl font-bold mt-2" id="totalRevenue">IDR 0</h2></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                    <div class="lg:col-span-2 glass-card p-4 sm:p-6"><h3 class="text-base sm:text-lg font-semibold mb-4">Revenue Overview</h3><canvas id="revenueChart" height="250"></canvas></div>
                    <div class="glass-card p-4 sm:p-6"><h3 class="text-base sm:text-lg font-semibold mb-4">Stock Status</h3><div id="stockStatus" class="space-y-3"></div></div>
                </div>
                <div class="glass-card p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-base sm:text-lg font-semibold">Recent Orders</h3><button onclick="showSection('orders')" class="text-[#60a5fa] text-sm">View All <i class="fas fa-arrow-right ml-1"></i></button></div>
                    <div class="overflow-x-auto"><table class="w-full"><thead><tr><th class="table-header">Order ID</th><th class="table-header">Customer</th><th class="table-header">Product</th><th class="table-header">Status</th></tr></thead><tbody id="recentOrdersTable"></tbody></table></div>
                </div>
            </div>

            <div id="ordersSection" class="hidden space-y-4 sm:space-y-6">
                <h1 class="text-2xl sm:text-3xl font-bold">Order Management</h1>
                <div class="glass-card p-4 sm:p-6"><div class="flex flex-wrap gap-3"><select id="orderStatusFilter" class="form-input w-full sm:w-auto"><option value="">All Status</option><option value="pending">Pending</option><option value="paid">Paid</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select><select id="orderProductFilter" class="form-input w-full sm:w-auto"><option value="">All Products</option></select><input type="text" id="orderSearch" placeholder="Search..." class="form-input flex-1"><button onclick="loadOrders()" class="btn-primary w-full sm:w-auto"><i class="fas fa-search mr-2"></i>Search</button></div></div>
                <div class="glass-card overflow-hidden"><div class="overflow-x-auto"><table class="w-full"><thead class="bg-white/5"><tr><th class="table-header">Order ID</th><th class="table-header">Customer</th><th class="table-header">Product</th><th class="table-header">Amount</th><th class="table-header">Status</th><th class="table-header">Date</th><th class="table-header">Actions</th></tr></thead><tbody id="ordersTable"></tbody></table></div><div id="ordersPagination" class="px-4 sm:px-6 py-4 border-t border-white/10 flex justify-center flex-wrap gap-2"></div></div>
            </div>

            <div id="accountsSection" class="hidden space-y-4 sm:space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h1 class="text-2xl sm:text-3xl font-bold">Account Stock</h1><button onclick="showUploadModal()" class="btn-primary w-full sm:w-auto"><i class="fas fa-upload mr-2"></i>Upload JSON</button></div>
                <div class="grid grid-cols-3 gap-3"><div class="stat-card"><p class="text-gray-400 text-xs">Total</p><h2 class="text-lg sm:text-xl font-bold mt-2" id="totalAccounts">0</h2></div><div class="stat-card"><p class="text-gray-400 text-xs">Available</p><h2 class="text-lg sm:text-xl font-bold mt-2 text-green-400" id="availableAccounts">0</h2></div><div class="stat-card"><p class="text-gray-400 text-xs">Sold</p><h2 class="text-lg sm:text-xl font-bold mt-2 text-blue-400" id="soldAccounts">0</h2></div></div>
                <div class="glass-card p-4 sm:p-6"><div class="flex flex-wrap gap-3"><select id="accountProductFilter" class="form-input w-full sm:w-auto"><option value="">All Products</option></select><select id="accountStatusFilter" class="form-input w-full sm:w-auto"><option value="">All Status</option><option value="available">Available</option><option value="sold">Sold</option></select><button onclick="showAddAccountModal()" class="btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Add Manual</button></div></div>
                <div class="glass-card overflow-hidden"><div class="overflow-x-auto"><table class="w-full"><thead class="bg-white/5"><tr><th class="table-header">ID</th><th class="table-header">Product</th><th class="table-header">Email</th><th class="table-header">Password</th><th class="table-header">2FA</th><th class="table-header">Status</th><th class="table-header">Actions</th></tr></thead><tbody id="accountsTable"></tbody></table></div><div id="accountsPagination" class="px-4 sm:px-6 py-4 border-t border-white/10 flex justify-center flex-wrap gap-2"></div></div>
            </div>

            <div id="productsSection" class="hidden space-y-4 sm:space-y-6">
                <h1 class="text-2xl sm:text-3xl font-bold">Product Management</h1>
                <div id="productsGrid" class="products-grid"></div>
            </div>

            <div id="settingsSection" class="hidden space-y-4 sm:space-y-6">
                <h1 class="text-2xl sm:text-3xl font-bold">System Settings</h1>
                <div class="glass-card p-4 sm:p-6"><div class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">Shop Name</label><input type="text" id="shopName" class="form-input" value="LyyShop ID"></div><div><label class="block text-sm text-gray-400 mb-2">Contact Email</label><input type="email" id="contactEmail" class="form-input" value="admin@lyytech.id"></div><div><label class="block text-sm text-gray-400 mb-2">WhatsApp</label><input type="text" id="whatsappNumber" class="form-input" value="6281234567890"></div><button onclick="saveSettings()" class="btn-primary w-full sm:w-auto">Save Settings</button></div></div>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl sm:text-2xl font-bold mb-6">Upload Accounts (JSON)</h2><form id="uploadForm" class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">Select Product</label><select id="uploadProductId" class="form-input" required><option value="">Choose product...</option></select></div><div><label class="block text-sm text-gray-400 mb-2">Upload JSON File</label><div id="fileDropArea" class="file-drop-area"><i class="fas fa-cloud-upload-alt text-3xl text-gray-500 mb-3"></i><p class="text-gray-300">Click to select or drag & drop</p><p class="text-xs text-gray-500 mt-2">JSON file max 5MB</p></div><input type="file" id="accountFile" accept=".json" class="hidden"><div id="fileInfo" class="mt-4 hidden"><div class="bg-white/5 rounded-lg p-4"><div class="flex items-center"><i class="fas fa-file-code text-[#60a5fa] text-2xl mr-3"></i><div class="flex-1"><p class="font-medium text-sm" id="fileName"></p><p class="text-xs text-gray-400" id="fileSize"></p></div><button type="button" onclick="clearFile()" class="text-red-400"><i class="fas fa-times"></i></button></div></div></div></div><div class="bg-white/5 rounded-lg p-4"><p class="text-sm text-gray-400 mb-2">JSON Format:</p><pre class="text-xs text-gray-500 overflow-x-auto">[{"email":"user@ex.com","password":"123","twofa":"GAX123"}]</pre></div><div class="flex flex-col sm:flex-row justify-end gap-3"><button type="button" onclick="hideUploadModal()" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary" id="uploadBtn" disabled>Upload</button></div></form></div></div>

    <div id="addAccountModal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl sm:text-2xl font-bold mb-6">Add Account Manually</h2><form id="addAccountForm" class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">Product</label><select id="addAccountProductId" class="form-input" required><option value="">Choose product...</option></select></div><div><label class="block text-sm text-gray-400 mb-2">Email</label><input type="email" id="addAccountEmail" class="form-input" required placeholder="user@ex.com"></div><div><label class="block text-sm text-gray-400 mb-2">Password</label><input type="text" id="addAccountPassword" class="form-input" required placeholder="password"></div><div><label class="block text-sm text-gray-400 mb-2">2FA (Optional)</label><input type="text" id="addAccountTwofa" class="form-input" placeholder="GAX123"></div><div><label class="block text-sm text-gray-400 mb-2">Additional (JSON)</label><textarea id="addAccountAdditional" class="form-input" rows="2" placeholder='{"note":"info"}'></textarea></div><div class="flex flex-col sm:flex-row justify-end gap-3"><button type="button" onclick="hideAddAccountModal()" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary">Add</button></div></form></div></div>

    <div id="completeOrderModal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl sm:text-2xl font-bold mb-4">Complete Order</h2><p class="text-gray-400 mb-4 text-sm break-all">Order: <span id="completeOrderId" class="text-[#60a5fa] font-mono"></span></p><div class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">Select Account</label><select id="manualAccountSelect" class="form-input" required><option value="">Loading...</option></select><div id="accountStockInfo" class="mt-2 text-sm text-gray-400"></div></div><div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4"><p class="text-xs sm:text-sm text-yellow-400"><i class="fas fa-exclamation-triangle mr-2"></i>This will send account details to customer.</p></div><div class="flex flex-col sm:flex-row justify-end gap-3"><button onclick="hideCompleteOrderModal()" class="btn-secondary">Cancel</button><button onclick="completeOrderManually()" class="btn-primary" id="completeOrderBtn">Complete</button></div></div></div></div>

    <div id="cancelOrderModal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl sm:text-2xl font-bold mb-4">Cancel Order</h2><p class="text-gray-400 mb-4 text-sm break-all">Order: <span id="cancelOrderId" class="text-[#60a5fa] font-mono"></span></p><div class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">Reason</label><input type="text" id="cancelReason" class="form-input" placeholder="Optional"></div><div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4"><p class="text-xs sm:text-sm text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>This cannot be undone.</p></div><div class="flex flex-col sm:flex-row justify-end gap-3"><button onclick="hideCancelOrderModal()" class="btn-secondary">Back</button><button onclick="cancelOrderManually()" class="btn-danger">Cancel Order</button></div></div></div></div>

    <div id="viewAccountModal" class="modal-overlay"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl sm:text-2xl font-bold">Account Details</h2><button onclick="hideViewAccountModal()" class="text-gray-400 hover:text-white text-2xl transition">&times;</button></div><div id="accountDetails" class="space-y-3 text-sm"></div></div></div>

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/80 z-[3000] flex items-center justify-center"><div class="text-center"><div class="spinner"></div><p id="loadingText" class="text-sm sm:text-base mt-4">Loading...</p></div></div>
    <div id="toast" class="toast hidden"></div>
    <div id="errorToast" class="toast error hidden"></div>

    <script>
        let token = localStorage.getItem('adminToken');
        let currentOrderPage = 1;
        let currentAccountPage = 1;
        let selectedFile = null;
        let revenueChart = null;
        let currentCompleteOrderId = null;
        let allProducts = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (token) verifyToken();
            loadProductsForDropdown();
        });

        async function verifyToken() {
            showLoading('Verifying...');
            try {
                const res = await fetch('/api/admin/verify', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) { hideLoading(); showDashboard(); loadDashboardData(); } 
                else { localStorage.removeItem('adminToken'); hideLoading(); }
            } catch { hideLoading(); }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            showLoading('Logging in...');
            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    localStorage.setItem('adminData', JSON.stringify(data.admin || {}));
                    hideLoading();
                    showDashboard();
                    loadDashboardData();
                    showToast('Login successful');
                } else {
                    hideLoading();
                    showLoginError(data.error || 'Login failed');
                }
            } catch {
                hideLoading();
                showLoginError('Network error');
            }
        });

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            const adminData = JSON.parse(localStorage.getItem('adminData') || '{}');
            document.getElementById('adminName').textContent = adminData.username || 'Admin';
        }

        function showLoginError(msg) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        async function loadDashboardData() {
            try {
                const res = await fetch('/api/admin/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('totalOrders').textContent = data.stats?.totalOrders || 0;
                    document.getElementById('completedOrders').textContent = data.stats?.completedOrders || 0;
                    document.getElementById('pendingOrders').textContent = data.stats?.pendingOrders || 0;
                    document.getElementById('totalRevenue').textContent = `IDR ${(data.stats?.totalRevenue || 0).toLocaleString()}`;
                    const badge = document.getElementById('pendingBadge');
                    if (data.stats?.pendingOrders > 0) { badge.textContent = data.stats.pendingOrders; badge.classList.remove('hidden'); } 
                    else badge.classList.add('hidden');
                    if (data.recentOrders) updateRecentOrders(data.recentOrders);
                    if (data.stockStatus) updateStockStatus(data.stockStatus);
                    if (data.revenueData) updateRevenueChart(data.revenueData);
                }
            } catch (error) { console.error(error); }
        }

        function updateRecentOrders(orders) {
            const tbody = document.getElementById('recentOrdersTable');
            if (!orders || orders.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No orders</td></tr>'; return; }
            tbody.innerHTML = orders.slice(0, 5).map(o => `<tr class="table-row"><td class="table-cell font-mono">${o.orderId || '-'}</td><td class="table-cell">${o.username || '-'}</td><td class="table-cell">${o.productName || o.role || '-'}</td><td class="table-cell"><span class="badge badge-${o.status || 'pending'}">${o.status || 'pending'}</span></td></tr>`).join('');
        }

        function updateStockStatus(products) {
            const container = document.getElementById('stockStatus');
            if (!products || products.length === 0) { container.innerHTML = '<p class="text-gray-400">No products</p>'; return; }
            container.innerHTML = products.map(p => {
                const percent = p.maxStock > 0 ? (p.stock / p.maxStock) * 100 : 0;
                const color = percent < 20 ? 'bg-red-500' : percent < 50 ? 'bg-yellow-500' : 'bg-green-500';
                return `<div><div class="flex justify-between text-xs mb-1"><span>${p.name}</span><span class="text-gray-400">${p.stock}/${p.maxStock}</span></div><div class="h-2 bg-white/10 rounded-full overflow-hidden"><div class="h-full ${color}" style="width: ${percent}%"></div></div></div>`;
            }).join('');
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: { labels: data.labels || [], datasets: [{ label: 'Revenue', data: data.values || [], borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white' } }, x: { grid: { display: false }, ticks: { color: 'white' } } }, animation: { duration: 1000 } }
            });
        }

        async function loadProductsForDropdown() {
            try {
                const res = await fetch('/api/roles');
                const data = await res.json();
                allProducts = data.roles || [];
                const selects = ['orderProductFilter', 'accountProductFilter', 'uploadProductId', 'addAccountProductId'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) select.innerHTML = '<option value="">All Products</option>' + allProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                });
            } catch (error) { console.error(error); }
        }

        async function loadAccounts(page = 1) {
            currentAccountPage = page;
            const product = document.getElementById('accountProductFilter')?.value || '';
            const status = document.getElementById('accountStatusFilter')?.value || '';
            let url = `/api/admin/accounts?page=${page}&limit=20`;
            if (product) url += `&product_id=${product}`;
            if (status) url += `&status=${status}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Auth failed');
                const data = await res.json();
                if (data.success) {
                    updateAccountsTable(data.accounts, data.pagination);
                    const statsRes = await fetch('/api/admin/accounts/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (statsRes.ok) {
                        const statsData = await statsRes.json();
                        if (statsData.success) {
                            document.getElementById('totalAccounts').textContent = statsData.stats?.total || 0;
                            document.getElementById('availableAccounts').textContent = statsData.stats?.available || 0;
                            document.getElementById('soldAccounts').textContent = statsData.stats?.sold || 0;
                            document.getElementById('stockBadge').textContent = statsData.stats?.available || 0;
                        }
                    }
                }
            } catch (error) { showError('Failed to load accounts'); }
        }

        function updateAccountsTable(accounts, pagination) {
            const tbody = document.getElementById('accountsTable');
            if (!accounts || accounts.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No accounts</td></tr>'; return; }
            tbody.innerHTML = accounts.map(acc => `<tr class="table-row"><td class="table-cell">#${acc.id}</td><td class="table-cell">${acc.product_id}</td><td class="table-cell">${acc.email}</td><td class="table-cell"><span class="font-mono">••••••••</span><button onclick="copyToClipboard('${acc.password}')" class="ml-2 text-[#60a5fa]"><i class="fas fa-copy"></i></button></td><td class="table-cell">${acc.twofa_code || '-'}</td><td class="table-cell"><span class="badge ${acc.status === 'available' ? 'badge-paid' : 'badge-completed'}">${acc.status}</span></td><td class="table-cell"><button onclick="viewAccount(${acc.id})" class="text-[#60a5fa] mr-2"><i class="fas fa-eye"></i></button>${acc.status === 'available' ? `<button onclick="deleteAccount(${acc.id})" class="text-red-400"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`).join('');
            updatePagination('accountsPagination', pagination, 'loadAccounts');
        }

        async function viewAccount(id) {
            try {
                const res = await fetch(`/api/admin/accounts/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) {
                    const a = data.account;
                    document.getElementById('accountDetails').innerHTML = `<p><span class="text-gray-400">ID:</span> ${a.id}</p><p><span class="text-gray-400">Product:</span> ${a.product_id}</p><p><span class="text-gray-400">Email:</span> ${a.email}</p><p><span class="text-gray-400">Password:</span> ${a.password}</p><p><span class="text-gray-400">2FA:</span> ${a.twofa_code || '-'}</p><p><span class="text-gray-400">Additional:</span></p><pre class="bg-white/5 p-2 rounded text-xs overflow-x-auto">${JSON.stringify(a.additional_info || {}, null, 2)}</pre><p><span class="text-gray-400">Status:</span> <span class="badge ${a.status === 'available' ? 'badge-paid' : 'badge-completed'}">${a.status}</span></p>`;
                    document.getElementById('viewAccountModal').classList.add('active');
                }
            } catch { showError('Failed to load'); }
        }

        function hideViewAccountModal() { document.getElementById('viewAccountModal').classList.remove('active'); }

        async function deleteAccount(id) {
            if (!confirm('Delete this account?')) return;
            try {
                const res = await fetch(`/api/admin/accounts/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) { showToast('Account deleted'); loadAccounts(currentAccountPage); } 
                else showError(data.error || 'Delete failed');
            } catch { showError('Network error'); }
        }

        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast('Copied!')).catch(() => showError('Failed')); }

        async function loadOrders(page = 1) {
            currentOrderPage = page;
            const status = document.getElementById('orderStatusFilter')?.value || '';
            const product = document.getElementById('orderProductFilter')?.value || '';
            const search = document.getElementById('orderSearch')?.value || '';
            let url = `/api/admin/orders?page=${page}&limit=20`;
            if (status) url += `&status=${status}`;
            if (product) url += `&product=${product}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) updateOrdersTable(data.orders, data.pagination);
            } catch { showError('Failed to load orders'); }
        }

        function updateOrdersTable(orders, pagination) {
            const tbody = document.getElementById('ordersTable');
            if (!orders || orders.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No orders</td></tr>'; return; }
            tbody.innerHTML = orders.map(o => `<tr class="table-row"><td class="table-cell font-mono">${o.orderId || '-'}</td><td class="table-cell">${o.username || '-'}</td><td class="table-cell">${o.productName || o.role || '-'}</td><td class="table-cell">Rp ${(o.amount || 0).toLocaleString()}</td><td class="table-cell"><span class="badge badge-${o.status || 'pending'}">${o.status || 'pending'}</span></td><td class="table-cell">${o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '-'}</td><td class="table-cell"><button onclick="viewOrder('${o.orderId}')" class="text-[#60a5fa] mr-2"><i class="fas fa-eye"></i></button>${o.status === 'pending' ? `<button onclick="showCompleteOrderModal('${o.orderId}')" class="text-green-400 mr-2"><i class="fas fa-check-circle"></i></button><button onclick="showCancelOrderModal('${o.orderId}')" class="text-red-400"><i class="fas fa-ban"></i></button>` : ''}</td></tr>`).join('');
            updatePagination('ordersPagination', pagination, 'loadOrders');
        }

        function viewOrder(orderId) { window.open(`/?order=${orderId}`, '_blank'); }

        async function showCompleteOrderModal(orderId) {
            document.getElementById('completeOrderId').textContent = orderId;
            document.getElementById('completeOrderModal').classList.add('active');
            currentCompleteOrderId = orderId;
            const select = document.getElementById('manualAccountSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            select.disabled = true;
            try {
                const orderRes = await fetch(`/api/order/${orderId}`);
                const orderData = await orderRes.json();
                if (!orderData.success) throw new Error('Order not found');
                let productId = orderData.order?.productId || orderData.order?.roleId || orderData.order?.role;
                if (productId) productId = productId.toLowerCase().trim();
                if (!productId) throw new Error('No product ID');
                const accountsRes = await fetch(`/api/admin/accounts?product_id=${encodeURIComponent(productId)}&status=available&limit=50`, { headers: { 'Authorization': `Bearer ${token}` } });
                const accountsData = await accountsRes.json();
                select.disabled = false;
                if (!accountsData.accounts || accountsData.accounts.length === 0) {
                    select.innerHTML = '<option value="">No accounts available</option>';
                    document.getElementById('accountStockInfo').innerHTML = '<span class="text-yellow-400">⚠️ No available accounts</span>';
                } else {
                    select.innerHTML = '<option value="">Choose account...</option>' + accountsData.accounts.map(a => `<option value="${a.id}">${a.email}</option>`).join('');
                    document.getElementById('accountStockInfo').innerHTML = `<span class="text-green-400">✅ ${accountsData.accounts.length} available</span>`;
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error loading</option>';
                select.disabled = false;
                showError('Failed to load accounts');
            }
        }

        function hideCompleteOrderModal() { document.getElementById('completeOrderModal').classList.remove('active'); }

        async function completeOrderManually() {
            const orderId = document.getElementById('completeOrderId').textContent;
            const accountId = document.getElementById('manualAccountSelect').value;
            if (!accountId) { showError('Select an account'); return; }
            const btn = document.getElementById('completeOrderBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            try {
                const res = await fetch(`/api/admin/orders/${orderId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ accountId })
                });
                const data = await res.json();
                if (data.success) { showToast('Order completed'); hideCompleteOrderModal(); loadOrders(currentOrderPage); loadAccounts(currentAccountPage); loadDashboardData(); } 
                else showError(data.error || 'Failed');
            } catch { showError('Network error'); } 
            finally { btn.disabled = false; btn.innerHTML = 'Complete'; }
        }

        function showCancelOrderModal(orderId) { document.getElementById('cancelOrderId').textContent = orderId; document.getElementById('cancelOrderModal').classList.add('active'); }
        function hideCancelOrderModal() { document.getElementById('cancelOrderModal').classList.remove('active'); }

        async function cancelOrderManually() {
            const orderId = document.getElementById('cancelOrderId').textContent;
            const reason = document.getElementById('cancelReason').value;
            showLoading('Cancelling...');
            try {
                const res = await fetch(`/api/admin/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ reason })
                });
                const data = await res.json();
                hideLoading(); hideCancelOrderModal();
                if (data.success) { showToast('Order cancelled'); loadOrders(currentOrderPage); loadDashboardData(); } 
                else showError(data.error || 'Failed');
            } catch { hideLoading(); showError('Network error'); }
        }

        function showUploadModal() { document.getElementById('uploadModal').classList.add('active'); setupFileUpload(); }
        function hideUploadModal() { document.getElementById('uploadModal').classList.remove('active'); clearFile(); }

        function setupFileUpload() {
            const fileInput = document.getElementById('accountFile');
            const dropArea = document.getElementById('fileDropArea');
            const uploadBtn = document.getElementById('uploadBtn');
            const newDropArea = dropArea.cloneNode(true); dropArea.parentNode.replaceChild(newDropArea, dropArea);
            const newFileInput = fileInput.cloneNode(true); fileInput.parentNode.replaceChild(newFileInput, fileInput);
            const updatedFileInput = document.getElementById('accountFile');
            const updatedDropArea = document.getElementById('fileDropArea');
            const updatedFileInfo = document.getElementById('fileInfo');

            updatedDropArea.onclick = () => updatedFileInput.click();
            updatedDropArea.ondragover = (e) => { e.preventDefault(); updatedDropArea.classList.add('dragover'); };
            updatedDropArea.ondragleave = () => updatedDropArea.classList.remove('dragover');
            updatedDropArea.ondrop = (e) => { e.preventDefault(); updatedDropArea.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
            updatedFileInput.onchange = (e) => handleFile(e.target.files[0]);

            function handleFile(file) {
                if (!file) return;
                if (!file.name.endsWith('.json')) { showError('Please select a JSON file'); return; }
                if (file.size > 5 * 1024 * 1024) { showError('File too large (max 5MB)'); return; }
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
                updatedFileInfo.classList.remove('hidden');
                uploadBtn.disabled = false;
            }
        }

        function clearFile() { selectedFile = null; document.getElementById('fileInfo').classList.add('hidden'); document.getElementById('uploadBtn').disabled = true; document.getElementById('accountFile').value = ''; }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('uploadProductId').value;
            if (!selectedFile || !productId) { showError('Select product and file'); return; }
            showLoading('Uploading...');
            try {
                const text = await selectedFile.text();
                const accounts = JSON.parse(text);
                const res = await fetch('/api/admin/accounts/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ productId, accounts })
                });
                const data = await res.json();
                hideLoading();
                if (data.success) { hideUploadModal(); showToast('Uploaded successfully'); loadAccounts(currentAccountPage); loadDashboardData(); } 
                else showError(data.error || 'Upload failed');
            } catch { hideLoading(); showError('Invalid JSON file'); }
        });

        function showAddAccountModal() { document.getElementById('addAccountModal').classList.add('active'); document.getElementById('addAccountForm').reset(); }
        function hideAddAccountModal() { document.getElementById('addAccountModal').classList.remove('active'); }

        document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('addAccountProductId').value;
            const email = document.getElementById('addAccountEmail').value;
            const password = document.getElementById('addAccountPassword').value;
            const twofa = document.getElementById('addAccountTwofa').value;
            const additionalText = document.getElementById('addAccountAdditional').value;
            if (!productId || !email || !password) { showError('Fill required fields'); return; }
            let additional = {};
            if (additionalText) { try { additional = JSON.parse(additionalText); } catch { showError('Invalid JSON'); return; } }
            showLoading('Adding...');
            try {
                const res = await fetch('/api/admin/accounts/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ productId, accounts: [{ email, password, twofa: twofa || undefined, additional }] })
                });
                const data = await res.json();
                hideLoading();
                if (data.success) { hideAddAccountModal(); showToast('Account added'); loadAccounts(currentAccountPage); } 
                else showError(data.error || 'Failed');
            } catch { hideLoading(); showError('Network error'); }
        });

        async function saveSettings() {
            const settings = {
                shopName: document.getElementById('shopName').value,
                contactEmail: document.getElementById('contactEmail').value,
                whatsappNumber: document.getElementById('whatsappNumber').value
            };
            showLoading('Saving...');
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(settings)
                });
                const data = await res.json();
                hideLoading();
                if (data.success) showToast('Settings saved');
                else showError(data.error || 'Save failed');
            } catch { hideLoading(); showError('Network error'); }
        }

        function showSection(section) {
            ['dashboardSection','ordersSection','accountsSection','productsSection','settingsSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (section === 'dashboard') document.getElementById('dashboardSection').classList.remove('hidden');
            if (section === 'orders') { document.getElementById('ordersSection').classList.remove('hidden'); loadOrders(); }
            if (section === 'accounts') { document.getElementById('accountsSection').classList.remove('hidden'); loadAccounts(); }
            if (section === 'products') { document.getElementById('productsSection').classList.remove('hidden'); loadProductsForDropdown(); }
            if (section === 'settings') document.getElementById('settingsSection').classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const active = Array.from(document.querySelectorAll('.sidebar-link')).find(l => l.textContent.toLowerCase().includes(section));
            if (active) active.classList.add('active');
        }

        function updatePagination(containerId, pagination, callback) {
            const container = document.getElementById(containerId);
            if (!container || !pagination || pagination.pages <= 1) { container.innerHTML = ''; return; }
            let html = '<div class="flex flex-wrap gap-2">';
            if (pagination.page > 1) html += `<button onclick="${callback}(${pagination.page - 1})" class="btn-secondary px-3 py-2">«</button>`;
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) html += `<span class="btn-primary px-3 py-2">${i}</span>`;
                else if (Math.abs(i - pagination.page) <= 2 || i === 1 || i === pagination.pages) html += `<button onclick="${callback}(${i})" class="btn-secondary px-3 py-2">${i}</button>`;
                else if (Math.abs(i - pagination.page) === 3) html += `<span class="btn-secondary px-3 py-2 opacity-50">...</span>`;
            }
            if (pagination.page < pagination.pages) html += `<button onclick="${callback}(${pagination.page + 1})" class="btn-secondary px-3 py-2">»</button>`;
            html += '</div>';
            container.innerHTML = html;
        }

        function showLoading(text) { document.getElementById('loadingText').textContent = text || 'Loading...'; document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
        function showError(msg) { const t = document.getElementById('errorToast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }

        function logout() { if (confirm('Logout?')) { localStorage.removeItem('adminToken'); localStorage.removeItem('adminData'); location.reload(); } }

        document.querySelectorAll('.modal-overlay').forEach(overlay => overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); }));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active')); });
    </script>
</body>
</html>
